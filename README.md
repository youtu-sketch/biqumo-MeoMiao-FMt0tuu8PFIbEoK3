
本文为博主原创，转载请注明出处：


　　SNAT（Source Network Address Translation，源网络地址转换）和DNAT（Destination Network Address Translation，目标网络地址转换）是网络地址转换（NAT）中的两种重要技术，它们在实现内部网络与外部网络之间的通信中发挥着关键作用。以下是对这两种技术的详细解释和它们的主要用途：


### 一、SNAT（源网络地址转换）


**定义**： SNAT是一种在IP数据包从内部网络发送到外部网络时，将源IP地址替换为公共IP地址的技术。这种转换允许内部网络中的多台设备通过共享一个或多个公共IP地址来访问外部网络。


**工作原理**： 当内部网络中的设备发送数据包到外部网络时，数据包经过NAT设备（如路由器或防火墙），NAT设备会自动将数据包的源IP地址替换为配置的公共IP地址。这样，外部网络中的设备看到的所有来自内部网络的数据包都似乎来自同一个公共IP地址。


**主要用途**：


1. **地址共享**：允许多个内部设备共享一个或多个公网IP地址访问互联网，从而节省公网IP资源。
2. **负载均衡**：在负载均衡场景中，SNAT可以将内部服务器的源IP地址替换为负载均衡器的IP地址，以实现流量分发和负载均衡。
3. **安全性**：通过隐藏内部网络的实际IP地址，SNAT可以增强内部网络的安全性，防止外部直接攻击内部设备。
4. **简化网络配置**：使用SNAT可以在规划地址时有更大的灵活性，简化内部网络的设计和配置。


### 二、DNAT（目标网络地址转换）


**定义**： DNAT是一种在IP数据包从外部网络发送到内部网络时，将目标IP地址替换为内部网络中的IP地址的技术。这种转换允许外部网络中的设备通过公共IP地址访问内部网络中的特定设备或服务。


**工作原理**： 当外部网络中的数据包到达NAT设备时，NAT设备会检查数据包的目标IP地址和端口号，并根据配置的DNAT规则将其替换为内部网络中的相应IP地址和端口号。然后，数据包被转发到内部网络中的指定设备。


**主要用途**：


1. **端口映射**：将外部网络中的公共IP地址和端口号映射到内部网络中的私有IP地址和端口号，实现远程访问、网站托管等功能。
2. **负载均衡**：在将外部流量分发到内部多个服务器时，DNAT可以根据负载均衡策略将流量转发到不同的服务器。
3. **安全性**：通过隐藏内部网络的实际IP地址和端口号，DNAT可以在一定程度上增强内部网络的安全性。


### 三、场景示例


**场景假设**


* 内部网络：192\.168\.1\.0/24
* 外部网络：互联网，假设通过ISP获得的公网IP为1\.2\.3\.4
* 内部服务器IP：192\.168\.1\.100，希望对外提供服务（例如Web服务）
* NAT服务器/防火墙IP：内网为192\.168\.1\.1，外网为1\.2\.3\.4


#### 3\.1 添加SNAT规则


　　允许外部访问内部服务器，首先，我们需要将到达NAT服务器的公网IP（1\.2\.3\.4）上的特定端口（例如HTTP的80端口）的数据包转发到内部服务器的相应端口。




```
# 添加SNAT规则  
# 将源地址是192.168.1.0/24的数据包的源地址改为1.2.3.4  
# 假设出站接口为eth0（连接到外部网络的接口），需要根据实际情况替换  
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j SNAT --to-source 1.2.3.4  
```


#### 3\.2 添加DNAT规则


　　允许外部访问内部服务器，需要将到达NAT服务器的公网IP（1\.2\.3\.4）上的特定端口（例如HTTP的80端口）的数据包转发到内部服务器的相应端口。




```
# 添加DNAT规则  
# 将目的地址为1.2.3.4且目的端口为80的数据包的目标地址改为192.168.1.100  
iptables -t nat -A PREROUTING -d 1.2.3.4 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:80  
```


* `-t nat`：指定要操作的表为NAT表。NAT表用于地址转换，包括源地址转换（SNAT）和目的地址转换（DNAT）。
* `-A PREROUTING`：向PREROUTING链添加一条规则。PREROUTING链用于处理进入本机的数据包，在路由决策之前进行。这意味着，对于进入本机的数据包，首先会经过PREROUTING链上的规则处理。
* `-d 1.2.3.4`：指定目的IP地址为1\.2\.3\.4的数据包会被这条规则匹配。这意味着，只有当数据包的目的地址是1\.2\.3\.4时，这条规则才会生效。
* `-p tcp`：指定协议类型为TCP。这意味着，只有TCP协议的数据包才会被这条规则匹配。
* `--dport 80`：指定目的端口为80。这意味着，只有目的端口为80的TCP数据包才会被这条规则匹配。
* `-j DNAT`：指定满足条件的数据包应该执行的动作是DNAT（目的地址转换）。DNAT用于将数据包的目的地址和/或端口号转换为其他值。
* `--to-destination 192.168.1.100:80`：指定转换后的目的地址和端口。这意味着，满足上述条件的数据包的目的地址将被转换为192\.168\.1\.100，目的端口将被转换为80。


 


 本博客参考[楚门加速器p](https://tianchuang88.com)。转载请注明出处！
